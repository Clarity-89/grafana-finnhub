/*! For license information please see module.js.LICENSE.txt */
define(["@grafana/data","react","@grafana/ui","rxjs","@grafana/runtime"],(function(e,t,n,r,a){return function(e){var t={};function n(r){if(t[r])return t[r].exports;var a=t[r]={i:r,l:!1,exports:{}};return e[r].call(a.exports,a,a.exports,n),a.l=!0,a.exports}return n.m=e,n.c=t,n.d=function(e,t,r){n.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:r})},n.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},n.t=function(e,t){if(1&t&&(e=n(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var r=Object.create(null);if(n.r(r),Object.defineProperty(r,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var a in e)n.d(r,a,function(t){return e[t]}.bind(null,a));return r},n.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return n.d(t,"a",t),t},n.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},n.p="/",n(n.s=7)}([function(t,n){t.exports=e},function(e,n){e.exports=t},function(e,t){e.exports=n},function(e,t){e.exports=r},function(e,t){e.exports=a},function(e,t,n){(function(t){var n="[\\ud800-\\udfff]",r="[\\u0300-\\u036f\\ufe20-\\ufe23\\u20d0-\\u20f0]",a="\\ud83c[\\udffb-\\udfff]",o="[^\\ud800-\\udfff]",u="(?:\\ud83c[\\udde6-\\uddff]){2}",i="[\\ud800-\\udbff][\\udc00-\\udfff]",l="(?:"+r+"|"+a+")"+"?",c="[\\ufe0e\\ufe0f]?"+l+("(?:\\u200d(?:"+[o,u,i].join("|")+")[\\ufe0e\\ufe0f]?"+l+")*"),s="(?:"+[o+r+"?",r,u,i,n].join("|")+")",f=RegExp(a+"(?="+a+")|"+s+c,"g"),p=RegExp("[\\u200d\\ud800-\\udfff\\u0300-\\u036f\\ufe20-\\ufe23\\u20d0-\\u20f0\\ufe0e\\ufe0f]"),d="object"==typeof t&&t&&t.Object===Object&&t,y="object"==typeof self&&self&&self.Object===Object&&self,m=d||y||Function("return this")();function v(e){return p.test(e)}function b(e){return v(e)?function(e){return e.match(f)||[]}(e):function(e){return e.split("")}(e)}var h=Object.prototype.toString,g=m.Symbol,w=g?g.prototype:void 0,T=w?w.toString:void 0;function F(e){if("string"==typeof e)return e;if(function(e){return"symbol"==typeof e||function(e){return!!e&&"object"==typeof e}(e)&&"[object Symbol]"==h.call(e)}(e))return T?T.call(e):"";var t=e+"";return"0"==t&&1/e==-1/0?"-0":t}function S(e,t,n){var r=e.length;return n=void 0===n?r:n,!t&&n>=r?e:function(e,t,n){var r=-1,a=e.length;t<0&&(t=-t>a?0:a+t),(n=n>a?a:n)<0&&(n+=a),a=t>n?0:n-t>>>0,t>>>=0;for(var o=Array(a);++r<a;)o[r]=e[r+t];return o}(e,t,n)}function O(e){return null==e?"":F(e)}var j,x=(j="toUpperCase",function(e){var t=v(e=O(e))?b(e):void 0,n=t?t[0]:e.charAt(0),r=t?S(t,1).join(""):e.slice(1);return n[j]()+r});e.exports=function(e){return x(O(e).toLowerCase())}}).call(this,n(6))},function(e,t){var n;n=function(){return this}();try{n=n||new Function("return this")()}catch(e){"object"==typeof window&&(n=window)}e.exports=n},function(e,t,n){"use strict";n.r(t);var r=n(0),a=function(e,t){return(a=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)Object.prototype.hasOwnProperty.call(t,n)&&(e[n]=t[n])})(e,t)};var o=function(){return(o=Object.assign||function(e){for(var t,n=1,r=arguments.length;n<r;n++)for(var a in t=arguments[n])Object.prototype.hasOwnProperty.call(t,a)&&(e[a]=t[a]);return e}).apply(this,arguments)};function u(e,t,n,r){return new(n||(n=Promise))((function(a,o){function u(e){try{l(r.next(e))}catch(e){o(e)}}function i(e){try{l(r.throw(e))}catch(e){o(e)}}function l(e){var t;e.done?a(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(u,i)}l((r=r.apply(e,t||[])).next())}))}function i(e,t){var n,r,a,o,u={label:0,sent:function(){if(1&a[0])throw a[1];return a[1]},trys:[],ops:[]};return o={next:i(0),throw:i(1),return:i(2)},"function"==typeof Symbol&&(o[Symbol.iterator]=function(){return this}),o;function i(o){return function(i){return function(o){if(n)throw new TypeError("Generator is already executing.");for(;u;)try{if(n=1,r&&(a=2&o[0]?r.return:o[0]?r.throw||((a=r.return)&&a.call(r),0):r.next)&&!(a=a.call(r,o[1])).done)return a;switch(r=0,a&&(o=[2&o[0],a.value]),o[0]){case 0:case 1:a=o;break;case 4:return u.label++,{value:o[1],done:!1};case 5:u.label++,r=o[1],o=[0];continue;case 7:o=u.ops.pop(),u.trys.pop();continue;default:if(!(a=u.trys,(a=a.length>0&&a[a.length-1])||6!==o[0]&&2!==o[0])){u=0;continue}if(3===o[0]&&(!a||o[1]>a[0]&&o[1]<a[3])){u.label=o[1];break}if(6===o[0]&&u.label<a[1]){u.label=a[1],a=o;break}if(a&&u.label<a[2]){u.label=a[2],u.ops.push(o);break}a[2]&&u.ops.pop(),u.trys.pop();continue}o=t.call(e,u)}catch(e){o=[6,e],r=0}finally{n=a=0}if(5&o[0])throw o[1];return{value:o[0]?o[1]:void 0,done:!0}}([o,i])}}}Object.create;function l(e,t){var n="function"==typeof Symbol&&e[Symbol.iterator];if(!n)return e;var r,a,o=n.call(e),u=[];try{for(;(void 0===t||t-- >0)&&!(r=o.next()).done;)u.push(r.value)}catch(e){a={error:e}}finally{try{r&&!r.done&&(n=o.return)&&n.call(o)}finally{if(a)throw a.error}}return u}function c(e,t,n){if(n||2===arguments.length)for(var r,a=0,o=t.length;a<o;a++)!r&&a in t||(r||(r=Array.prototype.slice.call(t,0,a)),r[a]=t[a]);return e.concat(r||Array.prototype.slice.call(t))}Object.create;var s,f=n(3),p=n(4);!function(e){e.Timeseries="TIMESERIES",e.Table="TABLE"}(s||(s={}));var d={type:{value:"profile2",label:"Profile"},format:s.Timeseries,count:1e3,resolution:1,symbol:"",metric:{value:"price",label:"price"}},y=["quote","earnings","candle","trades","social-sentiment"],m=new Map([["o","Opening price"],["h","High price"],["l","Low price"],["c","Closing price"],["v","Traded volume"],["t","Time"]]),v=function(e){return void 0===e&&(e={}),y.includes(e.value)?s.Timeseries:s.Table},b=function(e){return e?Array.isArray(e)?e:[e]:[]};function h(e){return(h="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}var g=function(e){function t(t,n){var a=e.call(this,t)||this;return a.backendSrv=n,a.tableResponse=function(e,t){return e&&"no_data"!==e.s?[new r.MutableDataFrame({refId:t.refId,fields:Object.entries(e).map((function(e){var t=l(e,2),n=t[0],a=t[1];return{name:n,type:"string"==typeof a?r.FieldType.string:r.FieldType.number,values:[a]}})),meta:{preferredVisualisationType:"table"}})]:[new r.MutableDataFrame({refId:t.refId,fields:[{name:"no data",type:r.FieldType.string,values:[]}],meta:{preferredVisualisationType:"table"}})]},a.dataSourceName=t.name,a.url=t.url,a}return t.$inject=["instanceSettings","backendSrv"],function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Class extends value "+String(t)+" is not a constructor or null");function n(){this.constructor=e}a(e,t),e.prototype=null===t?Object.create(t):(n.prototype=t.prototype,new n)}(t,e),t.prototype.constructQuery=function(e,t){var n,r,a,o=null===(n=e.symbol)||void 0===n?void 0:n.toUpperCase(),u=e.refId;switch(null===(r=e.type)||void 0===r?void 0:r.value){case"candle":return{symbol:o,resolution:e.resolution,from:t.from.unix(),to:t.to.unix(),refId:u};case"metric":return{symbol:o,metric:null===(a=null==e?void 0:e.metric)||void 0===a?void 0:a.value,refId:u};case"social-sentiment":return{symbol:o,from:t.from.format("YYYY-MM-DD"),to:t.to.format("YYYY-MM-DD"),refId:u};default:return{symbol:o,refId:u}}},t.prototype.query=function(e){var t=this,n=e.targets,a=e.range,u=n.filter((function(e){return!e.hide})),i=u.filter((function(e){var t;return"trades"===(null===(t=e.type)||void 0===t?void 0:t.value)})).map((function(e){var n=o(o({},d),e),u=t.constructQuery(n,a);return new f.Observable((function(e){var n=new r.CircularDataFrame({append:"tail",capacity:1e3});n.refId=u.refId,n.addField({name:"ts",type:r.FieldType.time}),n.addField({name:"value",type:r.FieldType.number});var a=function(e){var t=""+("https:"===window.location.protocol?"wss://":"ws://")+window.location.host+p.config.appSubUrl;return t.endsWith("/")&&(t=t.slice(0,-1)),""+t+e}(t.url+"/ws"),o=new WebSocket(a);return o.onopen=function(){return o.send(JSON.stringify({type:"subscribe",symbol:u.symbol}))},o.onerror=function(e){},o.onclose=function(){return e.complete()},o.onmessage=function(t){try{var r=JSON.parse(t.data);if("trade"===r.type){var a=r.data[0],o=a.t,i=a.p;n.add({ts:o,value:i}),e.next({data:[n],key:u.refId})}}catch(e){}},function(){o.send(JSON.stringify({type:"unsubscribe",symbol:u.symbol})),o.close()}}))})),y=u.filter((function(e){var t;return"trades"!==(null===(t=e.type)||void 0===t?void 0:t.value)})).map((function(e){var n,r=o(o({},d),e),u=r.queryText,i=r.type;if(u)n=t.freeTextQuery(u);else{var l=t.constructQuery(o(o({},d),e),a);n=t.get(i.value,l)}return n.then((function(n){var r=v(i)===s.Table;return n.metric&&(n=n.metric),r?t.tableResponse(n,e):t.tsResponse(n,e)}))})),m=Object(f.from)(Promise.all(y).then((function(e){return{data:e.flat()}})));return f.merge.apply(void 0,c(c([],l(i),!1),[m],!1))},t.prototype.tsResponse=function(e,t){var n=t.refId,a=[new r.MutableDataFrame({refId:n,fields:[{name:"no data",type:r.FieldType.string,values:[]}],meta:{preferredVisualisationType:"graph"}})];if("no_data"===(null==e?void 0:e.s)||"string"==typeof e)return a;switch(t.type.value){case"earnings":var o=["symbol"],u=Object.keys(e[0]).filter((function(e){return!o.includes(e)}));return[new r.MutableDataFrame({refId:n,fields:u.map((function(t){return{type:"period"===t?r.FieldType.time:r.FieldType.number,name:t,values:e.map((function(e){return"period"===t?Object(r.dateTime)(e[t]).valueOf():e[t]}))}})),meta:{preferredVisualisationType:"graph"}})];case"quote":var i=new Map([["t","time"],["c","current price"]]);return[new r.MutableDataFrame({refId:n,fields:c([],l(i),!1).map((function(t){var n=l(t,2),a=n[0],o=n[1];return{type:"t"===a?r.FieldType.time:r.FieldType.number,name:o,values:"t"===a?[1e3*e[a]]:[e[a]]}})),meta:{preferredVisualisationType:"table"}})];case"candle":return[new r.MutableDataFrame({refId:n,fields:c([],l(m),!1).map((function(t){var n=l(t,2),a=n[0],o=n[1];return{type:"t"===a?r.FieldType.time:r.FieldType.number,name:a,title:o,values:"t"===a?e[a].map((function(e){return 1e3*e})):e[a]}})),meta:{preferredVisualisationType:"graph"}})];case"social-sentiment":return Object.keys(e).filter((function(t){return"symbol"!==t&&!!e[t].length})).map((function(t){var a=e[t],o=Object.keys(a[0]),u=Object.fromEntries(o.map((function(e){return[e,a.map((function(t){return t[e]}))]})));return new r.MutableDataFrame({refId:n,fields:o.map((function(e){return{type:"atTime"===e?r.FieldType.time:r.FieldType.number,name:e+"-"+t,values:u[e].map((function(t){return"atTime"===e?Object(r.dateTime)(t).valueOf():t}))}})),meta:{preferredVisualisationType:"graph"}})}));default:var s=["t","time","period"];return[new r.MutableDataFrame({refId:n,fields:Object.entries(e).map((function(e){var t=l(e,2),n=t[0],a=t[1];return{type:s.includes(n)?r.FieldType.time:h(a),name:n,values:s.includes(n)?b(a).map((function(e){return 1e3*e})):b(a)}}))})]}},t.prototype.testDatasource=function(){return u(this,void 0,void 0,(function(){return i(this,(function(e){switch(e.label){case 0:return[4,this.get("profile2",{symbol:"AAPL"})];case 1:return 200===e.sent().status?[2,{status:"success"}]:[2,{status:"error"}]}}))}))},t.prototype.freeTextQuery=function(e){return u(this,void 0,void 0,(function(){return i(this,(function(t){switch(t.label){case 0:return t.trys.push([0,2,,3]),[4,this.backendSrv.get(this.url+"/api/"+e)];case 1:return[2,t.sent()];case 2:return t.sent(),[3,3];case 3:return[2]}}))}))},t.prototype.get=function(e,t){return void 0===t&&(t={}),u(this,void 0,void 0,(function(){var n;return i(this,(function(r){switch(r.label){case 0:n=this.url+"/api"+("quote"===e?"":"/stock"),r.label=1;case 1:return r.trys.push([1,3,,4]),[4,this.backendSrv.get(n+"/"+e,t)];case 2:return[2,r.sent()];case 3:throw r.sent();case 4:return[2]}}))}))},t}(r.DataSourceApi),w=n(1),T=n.n(w),F=n(2),S=n(5),O=n.n(S),j=c(c([],l(y),!1),l(["profile2","metric"]),!1),x=["price","valuation","growth","margin","management","financialStrength","perShare"].map((function(e){return{value:e,label:e}})),E=[{value:"1",label:"1"},{value:"5",label:"5"},{value:"15",label:"15"},{value:"30",label:"30"},{value:"60",label:"60"},{value:"D",label:"Day"},{value:"W",label:"Week"},{value:"M",label:"Month"}],I=function(e){var t=e.onChange,n=e.onRunQuery,r=e.query,a=function(e){var n=e.target.value,a=n.split("?")[0];t(o(o({},r),{queryText:n,format:v({value:a})}))},u=function(e){var n,a=e.target,u=a.name,i=a.value;t(o(o({},r),((n={})[u]=i,n)))},i=function(e){t(o(o({},r),{type:e})),"exchange"===e.value&&n()},l=function(e){t(o(o({},r),{metric:e}))},c=function(e){t(o(o({},r),{resolution:e.value}))},s=function(e){"Enter"===e.key&&n()},f=j.map((function(e){return{label:O()(e).replace(/\d+/g,""),value:e}})),p=o(o({},d),r),y=p.queryText,m=p.symbol,b=p.type,h=p.resolution,g=p.metric;return T.a.createElement(F.Form,{onSubmit:n},(function(e){e.register,e.errors;return T.a.createElement(T.a.Fragment,null,T.a.createElement(F.Field,{label:"Data type"},T.a.createElement(F.Select,{"data-testid":"Data type",onChange:i,options:f,value:b,defaultValue:b})),"exchange"!==b.value&&T.a.createElement(F.Field,{label:"Symbol"},T.a.createElement(F.Input,{value:m,name:"symbol",onChange:u,onKeyDown:s,placeholder:"Stock symbol"})),"candle"===b.value&&T.a.createElement(F.Field,{label:"Resolution"},T.a.createElement(F.Select,{onChange:c,options:E,value:h})),"metric"===b.value&&T.a.createElement(F.Field,{label:"Metric"},T.a.createElement(F.Select,{onChange:l,options:x,value:g,defaultValue:g})),"trades"!==b.value&&T.a.createElement(F.Field,{label:"Free Query Text",horizontal:!1,description:"Experimental. Will override any selected values above."},T.a.createElement(F.Input,{value:y||"",onChange:a,onKeyDown:s,placeholder:"Custom query e.g. 'earnings?symbol=AAPL'"})))}))};n.d(t,"plugin",(function(){return k}));var k=new r.DataSourcePlugin(g).setConfigEditor((function(e){var t=e.options,n=e.onOptionsChange,r=t.secureJsonData,a=t.secureJsonFields,u=!!(null==a?void 0:a.apiToken);return T.a.createElement(F.InlineFieldRow,null,T.a.createElement(F.InlineField,{label:"API Token",disabled:u,labelWidth:20,tooltip:T.a.createElement(T.a.Fragment,null,"Free API token can be created on"," ",T.a.createElement("a",{href:"https://finnhub.io/",about:"blank",rel:"noreferrer nopenner"},"Finnhub website"))},T.a.createElement(F.Input,{width:39.5,type:"password",value:(null==r?void 0:r.apiToken)||"",placeholder:u?"Configured":"Token for the Finnhub API",onChange:function(e){n(o(o({},t),{secureJsonData:{apiToken:e.target.value}}))}})),u&&T.a.createElement(F.Button,{variant:"secondary",onClick:function(){n(o(o({},t),{secureJsonFields:o(o({},t.secureJsonFields),{apiToken:!1}),secureJsonData:o(o({},t.secureJsonData),{apiToken:""})}))}},"Reset"))})).setQueryEditor(I).setExploreQueryField(I)}])}));
//# sourceMappingURL=module.js.map